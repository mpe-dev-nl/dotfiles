"use strict";var ce=Object.create;var R=Object.defineProperty;var fe=Object.getOwnPropertyDescriptor;var me=Object.getOwnPropertyNames;var pe=Object.getPrototypeOf,de=Object.prototype.hasOwnProperty;var S=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),_e=(r,e)=>{for(var s in e)R(r,s,{get:e[s],enumerable:!0})},O=(r,e,s,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of me(e))!de.call(r,a)&&a!==s&&R(r,a,{get:()=>e[a],enumerable:!(t=fe(e,a))||t.enumerable});return r};var E=(r,e,s)=>(s=r!=null?ce(pe(r)):{},O(e||!r||!r.__esModule?R(s,"default",{value:r,enumerable:!0}):s,r)),be=r=>O(R({},"__esModule",{value:!0}),r);var H=S((st,G)=>{"use strict";var ge=require("events"),q=r=>function(){this.done?this.done=!1:this.stack.push(this.current,this.key),this.current=new r,this.key=null},b=class extends ge{static connectTo(e,s){return new b(s).connectTo(e)}constructor(e){super(),this.stack=[],this.current=this.key=null,this.done=!0,e&&(this.reviver=typeof e.reviver=="function"&&e.reviver,this.reviver&&(this.stringValue=this._saveValue=this._saveValueWithReviver),e.numberAsString&&(this.numberValue=this.stringValue))}connectTo(e){return e.on("data",s=>{this[s.name]&&(this[s.name](s.value),this.done&&this.emit("done",this))}),this}get depth(){return(this.stack.length>>1)+(this.done?0:1)}get path(){let e=[];for(let s=0;s<this.stack.length;s+=2){let t=this.stack[s+1];e.push(t===null?this.stack[s].length:t)}return e}dropToLevel(e){if(e<this.depth)if(e){let s=e-1<<1;this.current=this.stack[s],this.key=this.stack[s+1],this.stack.splice(s)}else this.stack=[],this.current=this.key=null,this.done=!0;return this}consume(e){return this[e.name]&&this[e.name](e.value),this}keyValue(e){this.key=e}numberValue(e){this._saveValue(parseFloat(e))}nullValue(){this._saveValue(null)}trueValue(){this._saveValue(!0)}falseValue(){this._saveValue(!1)}endObject(){if(this.stack.length){let e=this.current;this.key=this.stack.pop(),this.current=this.stack.pop(),this._saveValue(e)}else this.done=!0}_saveValue(e){this.done?this.current=e:this.current instanceof Array?this.current.push(e):(this.current[this.key]=e,this.key=null)}_saveValueWithReviver(e){this.done?this.current=this.reviver("",e):this.current instanceof Array?(e=this.reviver(""+this.current.length,e),this.current.push(e),e===void 0&&delete this.current[this.current.length-1]):(e=this.reviver(this.key,e),e!==void 0&&(this.current[this.key]=e),this.key=null)}};b.prototype.stringValue=b.prototype._saveValue;b.prototype.startObject=q(Object);b.prototype.startArray=q(Array);b.prototype.endArray=b.prototype.endObject;G.exports=b});var F=S((rt,V)=>{"use strict";var{Transform:ve}=require("stream"),ye=H(),N=class{constructor(e){this.depth=e}startObject(){++this.depth}endObject(){--this.depth}startArray(){++this.depth}endArray(){--this.depth}},I=class extends ve{constructor(e){super(Object.assign({},e,{writableObjectMode:!0,readableObjectMode:!0})),e&&(this.objectFilter=e.objectFilter,this.includeUndecided=e.includeUndecided),typeof this.objectFilter!="function"&&(this._filter=this._transform),this._transform=this._wait||this._filter,this._assembler=new ye(e)}_transform(e,s,t){this._assembler[e.name]&&(this._assembler[e.name](e.value),this._assembler.depth===this._level&&this._push()),t(null)}_filter(e,s,t){if(this._assembler[e.name]){this._assembler[e.name](e.value);let a=this.objectFilter(this._assembler);if(a)return this._assembler.depth===this._level&&(this._push(),this._transform=this._filter),this._transform=this._accept,t(null);if(a===!1)return this._saved_assembler=this._assembler,this._assembler=new N(this._saved_assembler.depth),this._saved_assembler.dropToLevel(this._level),this._assembler.depth===this._level&&(this._assembler=this._saved_assembler,this._transform=this._filter),this._transform=this._reject,t(null);this._assembler.depth===this._level&&this._push(!this.includeUndecided)}t(null)}_accept(e,s,t){this._assembler[e.name]&&(this._assembler[e.name](e.value),this._assembler.depth===this._level&&(this._push(),this._transform=this._filter)),t(null)}_reject(e,s,t){this._assembler[e.name]&&(this._assembler[e.name](e.value),this._assembler.depth===this._level&&(this._assembler=this._saved_assembler,this._transform=this._filter)),t(null)}};V.exports=I});var $=S((nt,Z)=>{"use strict";var{Readable:at,Writable:it,Duplex:Se,Transform:U}=require("stream"),ke=Symbol.for("object-stream.none"),D=Symbol.for("object-stream.final"),A=Symbol.for("object-stream.many"),xe=r=>({[D]:r}),we=r=>({[A]:r}),Re=r=>r&&typeof r=="object"&&D in r,Ee=r=>r&&typeof r=="object"&&A in r,Pe=r=>r[D],Te=r=>r[A],Ne=async(r,e)=>{for(;;){let s=r.next();if(s&&typeof s.then=="function"&&(s=await s),s.done)break;let t=s.value;t&&typeof t.then=="function"&&(t=await t),h.sanitize(t,e)}},Ie=r=>new U({writableObjectMode:!0,readableObjectMode:!0,transform(e,s,t){try{let a=r.call(this,e,s);if(a&&typeof a.then=="function"){a.then(i=>(h.sanitize(i,this),t(null)),i=>t(i));return}if(a&&typeof a.next=="function"){Ne(a,this).then(()=>t(null),i=>t(i));return}h.sanitize(a,this),t(null)}catch(a){t(a)}}}),De=r=>new U({writableObjectMode:!0,readableObjectMode:!0,transform(e,s,t){try{let a=e;for(let i=0;i<r.length;++i){let u=r[i].call(this,a,s);if(u===h.none){t(null);return}if(h.isFinal(u)){a=h.getFinalValue(u);break}a=u}h.sanitize(a,this),t(null)}catch(a){t(a)}}}),j=r=>r&&typeof r.pipe=="function"&&typeof r.on=="function"&&(!r._writableState||(typeof r._readableState=="object"?r._readableState.readable:null)!==!1)&&(!r._writableState||r._readableState),K=r=>r&&typeof r.write=="function"&&typeof r.on=="function"&&(!r._readableState||(typeof r._writableState=="object"?r._writableState.writable:null)!==!1),Ae=r=>r&&typeof r.pipe=="function"&&r._readableState&&typeof r.on=="function"&&typeof r.write=="function",h=class extends Se{constructor(e,s){if(super(s||{writableObjectMode:!0,readableObjectMode:!0}),!(e instanceof Array)||!e.length)throw Error("Chain's argument should be a non-empty array.");this.streams=e.filter(t=>t).map((t,a,i)=>{if(typeof t=="function"||t instanceof Array)return h.convertToTransform(t);if(Ae(t)||!a&&j(t)||a===i.length-1&&K(t))return t;throw Error("Arguments should be functions, arrays or streams.")}).filter(t=>t),this.input=this.streams[0],this.output=this.streams.reduce((t,a)=>t&&t.pipe(a)||a),K(this.input)||(this._write=(t,a,i)=>i(null),this._final=t=>t(null),this.input.on("end",()=>this.end())),j(this.output)?(this.output.on("data",t=>!this.push(t)&&this.output.pause()),this.output.on("end",()=>this.push(null))):(this._read=()=>{},this.resume(),this.output.on("finish",()=>this.push(null))),(!s||!s.skipEvents)&&this.streams.forEach(t=>t.on("error",a=>this.emit("error",a)))}_write(e,s,t){let a=null;try{this.input.write(e,s,i=>t(i||a))}catch(i){a=i}}_final(e){let s=null;try{this.input.end(null,null,t=>e(t||s))}catch(t){s=t}}_read(){this.output.resume()}static make(e,s){return new h(e,s)}static sanitize(e,s){h.isFinal(e)?e=h.getFinalValue(e):h.isMany(e)&&(e=h.getManyValues(e)),e!=null&&e!==h.none&&(e instanceof Array?e.forEach(t=>t!=null&&s.push(t)):s.push(e))}static convertToTransform(e){return typeof e=="function"?Ie(e):e instanceof Array&&e.length?De(e):null}};h.none=ke;h.final=xe;h.isFinal=Re;h.getFinalValue=Pe;h.many=we;h.isMany=Ee;h.getManyValues=Te;h.chain=h.make;h.make.Constructor=h;Z.exports=h});var z=S((ut,W)=>{"use strict";var{Transform:Le}=require("stream"),{StringDecoder:Ce}=require("string_decoder"),L=class extends Le{constructor(e){super(Object.assign({},e,{writableObjectMode:!1})),this._buffer=""}_transform(e,s,t){typeof e=="string"?this._transform=this._transformString:(this._stringDecoder=new Ce,this._transform=this._transformBuffer),this._transform(e,s,t)}_transformBuffer(e,s,t){this._buffer+=this._stringDecoder.write(e),this._processBuffer(t)}_transformString(e,s,t){this._buffer+=e.toString(),this._processBuffer(t)}_processBuffer(e){this._buffer&&(this.push(this._buffer,"utf8"),this._buffer=""),e(null)}_flushInput(){this._stringDecoder&&(this._buffer+=this._stringDecoder.end())}_flush(e){this._flushInput(),this._processBuffer(e)}};W.exports=L});var J=S((ht,Q)=>{"use strict";var Me=z(),n={value1:/^(?:[\"\{\[\]\-\d]|true\b|false\b|null\b|\s{1,256})/,string:/^(?:[^\"\\]{1,256}|\\[bfnrt\"\\\/]|\\u[\da-fA-F]{4}|\")/,key1:/^(?:[\"\}]|\s{1,256})/,colon:/^(?:\:|\s{1,256})/,comma:/^(?:[\,\]\}]|\s{1,256})/,ws:/^\s{1,256}/,numberStart:/^\d/,numberDigit:/^\d{0,256}/,numberFraction:/^[\.eE]/,numberExponent:/^[eE]/,numberExpSign:/^[-+]/},Oe=16,p=!0;try{new RegExp(".","y"),p=!1}catch{}!p&&Object.keys(n).forEach(r=>{let e=n[r].source.slice(1);e.slice(0,3)==="(?:"&&e.slice(-1)===")"&&(e=e.slice(3,-1)),n[r]=new RegExp(e,"y")});n.numberFracStart=n.numberExpStart=n.numberStart;n.numberFracDigit=n.numberExpDigit=n.numberDigit;var Be={true:!0,false:!1,null:null},g={object:"objectStop",array:"arrayStop","":"done"},qe=r=>String.fromCharCode(parseInt(r.slice(2),16)),Ge={b:"\b",f:"\f",n:`
`,r:"\r",t:"	",'"':'"',"\\":"\\","/":"/"},y=class extends Me{static make(e){return new y(e)}constructor(e){super(Object.assign({},e,{readableObjectMode:!0})),this._packKeys=this._packStrings=this._packNumbers=this._streamKeys=this._streamStrings=this._streamNumbers=!0,e&&("packValues"in e&&(this._packKeys=this._packStrings=this._packNumbers=e.packValues),"packKeys"in e&&(this._packKeys=e.packKeys),"packStrings"in e&&(this._packStrings=e.packStrings),"packNumbers"in e&&(this._packNumbers=e.packNumbers),"streamValues"in e&&(this._streamKeys=this._streamStrings=this._streamNumbers=e.streamValues),"streamKeys"in e&&(this._streamKeys=e.streamKeys),"streamStrings"in e&&(this._streamStrings=e.streamStrings),"streamNumbers"in e&&(this._streamNumbers=e.streamNumbers),this._jsonStreaming=e.jsonStreaming),!this._packKeys&&(this._streamKeys=!0),!this._packStrings&&(this._streamStrings=!0),!this._packNumbers&&(this._streamNumbers=!0),this._done=!1,this._expect=this._jsonStreaming?"done":"value",this._stack=[],this._parent="",this._open_number=!1,this._accumulator=""}_flush(e){this._done=!0,super._flush(s=>{if(s)return e(s);this._open_number&&(this._streamNumbers&&this.push({name:"endNumber"}),this._open_number=!1,this._packNumbers&&(this.push({name:"numberValue",value:this._accumulator}),this._accumulator="")),e(null)})}_processBuffer(e){let s,t,a=0;e:for(;;)switch(this._expect){case"value1":case"value":if(n.value1.lastIndex=a,s=n.value1.exec(this._buffer),!s){if(this._done||a+Oe<this._buffer.length)return a<this._buffer.length?e(new Error("Parser cannot parse input: expected a value")):e(new Error("Parser has expected a value"));break e}switch(t=s[0],t){case'"':this._streamStrings&&this.push({name:"startString"}),this._expect="string";break;case"{":this.push({name:"startObject"}),this._stack.push(this._parent),this._parent="object",this._expect="key1";break;case"[":this.push({name:"startArray"}),this._stack.push(this._parent),this._parent="array",this._expect="value1";break;case"]":if(this._expect!=="value1")return e(new Error("Parser cannot parse input: unexpected token ']'"));this._open_number&&(this._streamNumbers&&this.push({name:"endNumber"}),this._open_number=!1,this._packNumbers&&(this.push({name:"numberValue",value:this._accumulator}),this._accumulator="")),this.push({name:"endArray"}),this._parent=this._stack.pop(),this._expect=g[this._parent];break;case"-":this._open_number=!0,this._streamNumbers&&(this.push({name:"startNumber"}),this.push({name:"numberChunk",value:"-"})),this._packNumbers&&(this._accumulator="-"),this._expect="numberStart";break;case"0":this._open_number=!0,this._streamNumbers&&(this.push({name:"startNumber"}),this.push({name:"numberChunk",value:"0"})),this._packNumbers&&(this._accumulator="0"),this._expect="numberFraction";break;case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":this._open_number=!0,this._streamNumbers&&(this.push({name:"startNumber"}),this.push({name:"numberChunk",value:t})),this._packNumbers&&(this._accumulator=t),this._expect="numberDigit";break;case"true":case"false":case"null":if(this._buffer.length-a===t.length&&!this._done)break e;this.push({name:t+"Value",value:Be[t]}),this._expect=g[this._parent];break}p?this._buffer=this._buffer.slice(t.length):a+=t.length;break;case"keyVal":case"string":if(n.string.lastIndex=a,s=n.string.exec(this._buffer),!s){if(a<this._buffer.length&&(this._done||this._buffer.length-a>=6))return e(new Error("Parser cannot parse input: escaped characters"));if(this._done)return e(new Error("Parser has expected a string value"));break e}if(t=s[0],t==='"')this._expect==="keyVal"?(this._streamKeys&&this.push({name:"endKey"}),this._packKeys&&(this.push({name:"keyValue",value:this._accumulator}),this._accumulator=""),this._expect="colon"):(this._streamStrings&&this.push({name:"endString"}),this._packStrings&&(this.push({name:"stringValue",value:this._accumulator}),this._accumulator=""),this._expect=g[this._parent]);else if(t.length>1&&t.charAt(0)==="\\"){let i=t.length==2?Ge[t.charAt(1)]:qe(t);(this._expect==="keyVal"?this._streamKeys:this._streamStrings)&&this.push({name:"stringChunk",value:i}),(this._expect==="keyVal"?this._packKeys:this._packStrings)&&(this._accumulator+=i)}else(this._expect==="keyVal"?this._streamKeys:this._streamStrings)&&this.push({name:"stringChunk",value:t}),(this._expect==="keyVal"?this._packKeys:this._packStrings)&&(this._accumulator+=t);p?this._buffer=this._buffer.slice(t.length):a+=t.length;break;case"key1":case"key":if(n.key1.lastIndex=a,s=n.key1.exec(this._buffer),!s){if(a<this._buffer.length||this._done)return e(new Error("Parser cannot parse input: expected an object key"));break e}if(t=s[0],t==='"')this._streamKeys&&this.push({name:"startKey"}),this._expect="keyVal";else if(t==="}"){if(this._expect!=="key1")return e(new Error("Parser cannot parse input: unexpected token '}'"));this.push({name:"endObject"}),this._parent=this._stack.pop(),this._expect=g[this._parent]}p?this._buffer=this._buffer.slice(t.length):a+=t.length;break;case"colon":if(n.colon.lastIndex=a,s=n.colon.exec(this._buffer),!s){if(a<this._buffer.length||this._done)return e(new Error("Parser cannot parse input: expected ':'"));break e}t=s[0],t===":"&&(this._expect="value"),p?this._buffer=this._buffer.slice(t.length):a+=t.length;break;case"arrayStop":case"objectStop":if(n.comma.lastIndex=a,s=n.comma.exec(this._buffer),!s){if(a<this._buffer.length||this._done)return e(new Error("Parser cannot parse input: expected ','"));break e}if(this._open_number&&(this._streamNumbers&&this.push({name:"endNumber"}),this._open_number=!1,this._packNumbers&&(this.push({name:"numberValue",value:this._accumulator}),this._accumulator="")),t=s[0],t===",")this._expect=this._expect==="arrayStop"?"value":"key";else if(t==="}"||t==="]"){if(t==="}"?this._expect==="arrayStop":this._expect!=="arrayStop")return e(new Error("Parser cannot parse input: expected '"+(this._expect==="arrayStop"?"]":"}")+"'"));this.push({name:t==="}"?"endObject":"endArray"}),this._parent=this._stack.pop(),this._expect=g[this._parent]}p?this._buffer=this._buffer.slice(t.length):a+=t.length;break;case"numberStart":if(n.numberStart.lastIndex=a,s=n.numberStart.exec(this._buffer),!s){if(a<this._buffer.length||this._done)return e(new Error("Parser cannot parse input: expected a starting digit"));break e}t=s[0],this._streamNumbers&&this.push({name:"numberChunk",value:t}),this._packNumbers&&(this._accumulator+=t),this._expect=t==="0"?"numberFraction":"numberDigit",p?this._buffer=this._buffer.slice(t.length):a+=t.length;break;case"numberDigit":if(n.numberDigit.lastIndex=a,s=n.numberDigit.exec(this._buffer),!s){if(a<this._buffer.length||this._done)return e(new Error("Parser cannot parse input: expected a digit"));break e}if(t=s[0],t)this._streamNumbers&&this.push({name:"numberChunk",value:t}),this._packNumbers&&(this._accumulator+=t),p?this._buffer=this._buffer.slice(t.length):a+=t.length;else{if(a<this._buffer.length){this._expect="numberFraction";break}if(this._done){this._expect=g[this._parent];break}break e}break;case"numberFraction":if(n.numberFraction.lastIndex=a,s=n.numberFraction.exec(this._buffer),!s){if(a<this._buffer.length||this._done){this._expect=g[this._parent];break}break e}t=s[0],this._streamNumbers&&this.push({name:"numberChunk",value:t}),this._packNumbers&&(this._accumulator+=t),this._expect=t==="."?"numberFracStart":"numberExpSign",p?this._buffer=this._buffer.slice(t.length):a+=t.length;break;case"numberFracStart":if(n.numberFracStart.lastIndex=a,s=n.numberFracStart.exec(this._buffer),!s){if(a<this._buffer.length||this._done)return e(new Error("Parser cannot parse input: expected a fractional part of a number"));break e}t=s[0],this._streamNumbers&&this.push({name:"numberChunk",value:t}),this._packNumbers&&(this._accumulator+=t),this._expect="numberFracDigit",p?this._buffer=this._buffer.slice(t.length):a+=t.length;break;case"numberFracDigit":if(n.numberFracDigit.lastIndex=a,s=n.numberFracDigit.exec(this._buffer),t=s[0],t)this._streamNumbers&&this.push({name:"numberChunk",value:t}),this._packNumbers&&(this._accumulator+=t),p?this._buffer=this._buffer.slice(t.length):a+=t.length;else{if(a<this._buffer.length){this._expect="numberExponent";break}if(this._done){this._expect=g[this._parent];break}break e}break;case"numberExponent":if(n.numberExponent.lastIndex=a,s=n.numberExponent.exec(this._buffer),!s){if(a<this._buffer.length){this._expect=g[this._parent];break}if(this._done){this._expect="done";break}break e}t=s[0],this._streamNumbers&&this.push({name:"numberChunk",value:t}),this._packNumbers&&(this._accumulator+=t),this._expect="numberExpSign",p?this._buffer=this._buffer.slice(t.length):a+=t.length;break;case"numberExpSign":if(n.numberExpSign.lastIndex=a,s=n.numberExpSign.exec(this._buffer),!s){if(a<this._buffer.length){this._expect="numberExpStart";break}if(this._done)return e(new Error("Parser has expected an exponent value of a number"));break e}t=s[0],this._streamNumbers&&this.push({name:"numberChunk",value:t}),this._packNumbers&&(this._accumulator+=t),this._expect="numberExpStart",p?this._buffer=this._buffer.slice(t.length):a+=t.length;break;case"numberExpStart":if(n.numberExpStart.lastIndex=a,s=n.numberExpStart.exec(this._buffer),!s){if(a<this._buffer.length||this._done)return e(new Error("Parser cannot parse input: expected an exponent part of a number"));break e}t=s[0],this._streamNumbers&&this.push({name:"numberChunk",value:t}),this._packNumbers&&(this._accumulator+=t),this._expect="numberExpDigit",p?this._buffer=this._buffer.slice(t.length):a+=t.length;break;case"numberExpDigit":if(n.numberExpDigit.lastIndex=a,s=n.numberExpDigit.exec(this._buffer),t=s[0],t)this._streamNumbers&&this.push({name:"numberChunk",value:t}),this._packNumbers&&(this._accumulator+=t),p?this._buffer=this._buffer.slice(t.length):a+=t.length;else{if(a<this._buffer.length||this._done){this._expect=g[this._parent];break}break e}break;case"done":if(n.ws.lastIndex=a,s=n.ws.exec(this._buffer),!s){if(a<this._buffer.length){if(this._jsonStreaming){this._expect="value";break}return e(new Error("Parser cannot parse input: unexpected characters"))}break e}t=s[0],this._open_number&&(this._streamNumbers&&this.push({name:"endNumber"}),this._open_number=!1,this._packNumbers&&(this.push({name:"numberValue",value:this._accumulator}),this._accumulator="")),p?this._buffer=this._buffer.slice(t.length):a+=t.length;break}!p&&(this._buffer=this._buffer.slice(a)),e(null)}};y.parser=y.make;y.make.Constructor=y;Q.exports=y});var X=S((ot,Y)=>{"use strict";var He=$(),Ve=J(),Fe=(r,e)=>new He([new Ve(e),r(e)],Object.assign({},e,{writableObjectMode:!1,readableObjectMode:!0}));Y.exports=Fe});var te=S((lt,ee)=>{"use strict";var je=F(),Ke=X(),v=class extends je{static make(e){return new v(e)}static withParser(e){return Ke(v.make,e)}constructor(e){super(e),this._level=1,this._counter=0}_wait(e,s,t){return e.name!=="startArray"?t(new Error("Top-level object should be an array.")):(this._transform=this._filter,this._transform(e,s,t))}_push(e){this._assembler.current.length&&(e?(++this._counter,this._assembler.current.pop()):this.push({key:this._counter++,value:this._assembler.current.pop()}))}};v.streamArray=v.make;v.make.Constructor=v;ee.exports=v});var ze={};_e(ze,{default:()=>le});module.exports=be(ze);var f=require("@raycast/api");var B="bridgeCredentials",T=[100,90,80,70,60,50,40,30,20,10,1],Je=T[T.length-1],Ye=T[0];var Xe=(500-153)/10;var P=require("http2"),ne=E(require("fs")),ue=require("@raycast/api"),he=E(require("dns"));var x=require("http2");var k=class{constructor(e,s){this.queue=[];this.isProcessing=!1;this.lastRequestTimestamp=0;this.requestsPerSecond=e,this.maxQueueLength=s}async enqueueRequest(e){return new Promise((s,t)=>{this.maxQueueLength&&this.queue.length>this.maxQueueLength||(this.queue.push(async()=>{try{let a=await e();return s(a)}catch(a){return t(a)}finally{this.processNext()}}),this.isProcessing||this.processNext())})}processNext(){if(this.queue.length===0){this.isProcessing=!1;return}this.isProcessing=!0;let s=Date.now()-this.lastRequestTimestamp,t=Math.max(0,1e3/this.requestsPerSecond-s);setTimeout(()=>{let a=this.queue.shift();a&&(this.lastRequestTimestamp=Date.now(),a().then())},t)}};var ie=E(te());Array.prototype.updateItem||(Array.prototype.updateItem=function(r,e){return this.map(s=>s.id!==r?s:{...s,...e})});Array.prototype.updateItems||(Array.prototype.updateItems=function(r){return this.map(e=>{let s=r.get(e.id);return s?{...e,...s}:e})});Array.prototype.replaceItems||(Array.prototype.replaceItems=function(r){return this.map(e=>{let s=r.find(t=>t.id===e.id);return s?{...e,...s}:e})});Array.prototype.mergeObjectsById||(Array.prototype.mergeObjectsById=function(){return Object.values(this.reduce((r,e)=>(r[e.id]=r[e.id]?{...r[e.id],...e}:e,r),{}))});var se="data: ",{HTTP2_HEADER_METHOD:re,HTTP2_HEADER_PATH:ae,HTTP2_HEADER_ACCEPT:Ue}=x.constants,w=class{constructor(e,s,t,a,i,u,o){this.lightsQueue=new k(10);this.groupedLightsQueue=new k(1,1);this.http2Session=s,this.bridgeConfig=e,this.setLights=t,this.setGroupedLights=a,this.setRooms=i,this.setZones=u,this.setScenes=o,this.listenToEventSource()}async getLights(){return(await this.makeRequest("GET","/clip/v2/resource/light")).data.data}async getGroupedLights(){return(await this.makeRequest("GET","/clip/v2/resource/grouped_light")).data.data}async getScenes(){return(await this.makeRequest("GET","/clip/v2/resource/scene")).data.data}async getRooms(){return(await this.makeRequest("GET","/clip/v2/resource/room")).data.data}async getZones(){return(await this.makeRequest("GET","/clip/v2/resource/zone")).data.data}async updateLight(e,s){return(await this.lightsQueue.enqueueRequest(()=>this.makeRequest("PUT",`/clip/v2/resource/light/${e.id}`,s))).data.data}async updateGroupedLight(e,s){return(await this.groupedLightsQueue.enqueueRequest(()=>this.makeRequest("PUT",`/clip/v2/resource/grouped_light/${e.id}`,s))).data.data}async updateScene(e,s){return(await this.makeRequest("PUT",`/clip/v2/resource/scene/${e.id}`,s)).data.data}makeRequest(e,s,t){return new Promise((a,i)=>{let u=this.http2Session.request({[re]:e,[ae]:s,"hue-application-key":this.bridgeConfig.username,[x.sensitiveHeaders]:["hue-application-key"]}),o="";t!==void 0&&u.write(JSON.stringify(t),"utf8"),u.setEncoding("utf8");let l={headers:{},data:{errors:[],data:[]}};u.on("response",c=>{l.headers=c}),u.on("data",c=>{o+=c}),u.on("end",()=>{u.close();try{if(l.headers[":status"]!==200&&l.headers["content-type"]==="text/html"){let c=o.match(/(?<=<div class="error">)(.*?)(?=<\/div>)/);if(c&&c[0])return console.error({headers:l.headers,message:c[0]}),i(`Status ${l.headers[":status"]}: ${c[0]}`)}if(l.data=JSON.parse(o),l.data.errors!=null&&l.data.errors.length>0){let c=l.data.errors.map(d=>d.description).join(", ");return console.error({headers:l.headers,message:c}),i(c)}return a(l)}catch(c){return i(c)}}),u.on("error",c=>i(c)),u.end()})}listenToEventSource(){let e=this.http2Session.request({[re]:"GET",[ae]:"/eventstream/clip/v2",[Ue]:"text/event-stream","hue-application-key":this.bridgeConfig.username,[x.sensitiveHeaders]:["hue-application-key"]}),s=null,t=({value:a})=>{this.setLights?.(i=>{let u=a.data.filter(o=>o.type==="light");return i.replaceItems(u.mergeObjectsById())}),this.setGroupedLights?.(i=>{let u=a.data.filter(o=>o.type==="grouped_light");return i.replaceItems(u)}),this.setRooms?.(i=>{let u=a.data.filter(o=>o.type==="room");return i.replaceItems(u)}),this.setZones?.(i=>{let u=a.data.filter(o=>o.type==="zone");return i.replaceItems(u)}),this.setScenes?.(i=>{let u=a.data.filter(o=>o.type==="scene");return i.replaceItems(u)}),s=null};e.setEncoding("utf8"),e.on("data",a=>{s??=Ze(s,t);let i=a.split(`
`);for(let u of i){let o=u.indexOf(se);if(o===-1)continue;let l=u.substring(o+se.length);s.write(l)}}),e.on("end",()=>{s?.end(),e.close()}),e.on("error",a=>{s?.end(),e.close(),console.error(a,[s?.input])})}};function Ze(r,e){return r=ie.default.withParser(),r.on("data",s=>{e(s),r=null}),r.on("error",s=>{console.error(s)}),r}var oe=E(require("path")),$e=5e3;async function C(r,e,s,t,a,i){let u=await new Promise((o,l)=>{let c;r.certificateType==="self-signed"&&r.certificate?(c=Buffer.from(r.certificate,"utf-8"),console.log("Connecting to the Hue Bridge using it\u2019s self-signed certificate\u2026")):(c=ne.default.readFileSync(oe.join(ue.environment.assetsPath,"huebridge_cacert.pem")),console.log("Connecting to the Hue Bridge, checking it\u2019s certificate against the Hue Bridge root CA\u2026"));let d=(0,P.connect)(`https://${r.id}`,{ca:c,checkServerIdentity:(_,m)=>{if(m.subject.CN!==r.id)throw new Error("Server identity check failed. Certificate subject\u2019s Common Name does not match the Bridge ID.");if(r.certificateType==="signed-by-hue-bridge-root-ca"&&m.issuer.CN!=="root-bridge")throw new Error("Server identity check failed. Certificate issuer\u2019s Common Name does not match the expected value.");if(r.certificateType==="self-signed"&&m.issuer.CN!==r.id)throw new Error("Server identity check failed. Certificate issuer\u2019s Common Name does not match the Bridge ID.")},lookup:(_,m,M)=>{r.ipAddress!==void 0&&_.toLowerCase()===r.id?M(null,[{address:r.ipAddress,family:4}]):he.default.lookup(_,m,M)}});d.setTimeout($e,()=>l("Connection timed out.")),d.once("connect",()=>{d.request({":method":"GET",":path":"/clip/v2/resource/bridge","hue-application-key":r.username,[P.sensitiveHeaders]:["hue-application-key"]}).on("response",m=>m[":status"]===403?l("Please check your username."):m[":status"]!==200?l("Status code: "+m[":status"]):o(d))}),d.once("error",_=>l(_))});return new w(r,u,e,s,t,a,i)}async function le(){try{let r=await f.LocalStorage.getItem(B);if(r===void 0)throw Error("No Hue Bridge configured");let e=JSON.parse(r),s=await C(e),t=await s.getLights(),a=t.filter(_=>_.on.on);f.environment.launchType==="userInitiated"&&await We(t,a,s);let i=await s.getLights(),u=i.filter(_=>_.on.on),o=await s.getGroupedLights(),l=await s.getZones(),c=await s.getScenes(),d=new f.Cache;t.length>0&&d.set("lights",JSON.stringify(i)),o.length>0&&d.set("groupedLights",JSON.stringify(o)),l.length>0&&d.set("zones",JSON.stringify(l)),c.length>0&&d.set("scenes",JSON.stringify(c)),u.length===0?(0,f.updateCommandMetadata)({subtitle:"All lights are off"}).then():u.length===t.length?(0,f.updateCommandMetadata)({subtitle:"All lights are on"}).then():(0,f.updateCommandMetadata)({subtitle:`${u.length} of ${t.length} lights are on`}).then()}catch(r){if(f.environment.launchType!=="userInitiated"||!(r instanceof Error))throw r;console.error(r.message),(0,f.showHUD)(r.message).then()}finally{f.environment.launchType==="userInitiated"&&await(0,f.closeMainWindow)()}}async function We(r,e,s){let{toggleAllLights:t}=(0,f.getPreferenceValues)(),a=new f.Toast({style:f.Toast.Style.Animated,title:"",message:"Please wait\u2026"}),i=e.length===0||t==="on"&&r.length!==e.length,u,o,l;i?(u="Turning on all lights\u2026",o=`Turned on all ${r.length} lights.`,l=`failed turning on ${r.length} lights.`):(u="Turning off all lights\u2026",o=`Turned off all ${e.length} lights that were on.`,l=`failed turning off ${e.length} lights that were on.`),a.title=u,a.show().then();let c=await Promise.allSettled(r.filter(m=>i?!e.includes(m):e.includes(m)).map(m=>s.updateLight(m,{on:{on:i}}))),d=c.filter(m=>m.status==="fulfilled").length;c.filter(m=>m.status==="rejected").length===0?(0,f.showHUD)(o).then():(0,f.showHUD)(`Turned on ${d} lights, ${l}`).then()}
